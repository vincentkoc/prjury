name: prjury (example)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

env:
  PRJURY_INPUT_DIR: outputs

jobs:
  codex:
    if: ${{ vars.PRJURY_RUN_CODEX == 'true' }}
    runs-on: ubuntu-latest
    env:
      PRJURY_INPUT_DIR: ${{ env.PRJURY_INPUT_DIR }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Cache Codex CLI state
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.codex
          key: ${{ runner.os }}-codex-cli-v1

      - run: mkdir -p "$PRJURY_INPUT_DIR"

      - name: Codex adapter
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are a PR reviewer. Emit ONLY JSON array:
            [{"tool":"codex","severity":"blocker|major|minor|nit","file":"path","line":0,"message":"...", "suggestion":"..."}]
            Review the diff in this repo for issues.
          output-schema: |
            {
              "type": "object",
              "properties": {
                "findings": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["tool", "severity", "file", "line", "message"],
                    "properties": {
                      "tool": { "const": "codex" },
                      "severity": { "enum": ["blocker", "major", "minor", "nit"] },
                      "file": { "type": "string" },
                      "line": { "type": "integer" },
                      "message": { "type": "string" },
                      "suggestion": { "type": "string" }
                    },
                    "additionalProperties": false
                  },
                  "additionalProperties": false
                }
              },
              "required": ["findings"],
              "additionalProperties": false
            }
          output-file: ${{ env.PRJURY_INPUT_DIR }}/codex.raw.json
          sandbox: read-only

      - name: Normalize Codex JSON
        run: |
          jq '.findings // []' "${PRJURY_INPUT_DIR}/codex.raw.json" > "${PRJURY_INPUT_DIR}/codex.json"

      - uses: actions/upload-artifact@v4
        with:
          name: codex-json
          path: ${{ env.PRJURY_INPUT_DIR }}/codex.json

  gemini:
    if: ${{ vars.PRJURY_RUN_GEMINI == 'true' }}
    runs-on: ubuntu-latest
    env:
      PRJURY_INPUT_DIR: ${{ env.PRJURY_INPUT_DIR }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Cache Gemini CLI state
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            .gemini
          key: ${{ runner.os }}-gemini-cli-v1

      - run: mkdir -p "$PRJURY_INPUT_DIR"

      - name: Gemini adapter
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash
          prompt: |
            Emit ONLY JSON array:
            [{"tool":"gemini","severity":"blocker|major|minor|nit","file":"path","line":0,"message":"...", "suggestion":"..."}]
            Review changed files.
          upload_artifacts: "false"

      - name: Normalize Gemini JSON
        run: |
          cat <<'EOF' > "${PRJURY_INPUT_DIR}/gemini.raw.txt"
${{ steps.gemini.outputs.summary }}
EOF
          if [ ! -s "${PRJURY_INPUT_DIR}/gemini.raw.txt" ]; then
            echo "[]" > "${PRJURY_INPUT_DIR}/gemini.json"
          else
            jq '.' "${PRJURY_INPUT_DIR}/gemini.raw.txt" > "${PRJURY_INPUT_DIR}/gemini.json" || echo "[]" > "${PRJURY_INPUT_DIR}/gemini.json"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: gemini-json
          path: ${{ env.PRJURY_INPUT_DIR }}/gemini.json

  greptile:
    if: ${{ vars.PRJURY_RUN_GREPTILE == 'true' }}
    runs-on: ubuntu-latest
    env:
      PRJURY_INPUT_DIR: ${{ env.PRJURY_INPUT_DIR }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Cache greptile CLI
        uses: actions/cache@v4
        with:
          path: ~/.cache/greptile
          key: ${{ runner.os }}-greptile-cli-v1

      - run: mkdir -p "$PRJURY_INPUT_DIR"

      - name: Install greptile CLI
        run: pip install --user greptile-cli

      - name: Greptile adapter
        env:
          GREPTILE_API_KEY: ${{ secrets.GREPTILE_API_KEY }}
          PATH: ${{ env.PATH }}:~/.local/bin
        run: |
          greptile pr review \
            --repo "$GITHUB_REPOSITORY" \
            --pr "${{ github.event.pull_request.number }}" \
            --format json > "${PRJURY_INPUT_DIR}/greptile.raw.json" || true
          jq '[.findings[] | {
                tool: "greptile",
                severity: (.severity // "minor"),
                file: (.file // .path // ""),
                line: (.line // .start_line // null),
                message: (.message // .description // ""),
                suggestion: (.suggestion // .recommendation // null)
              }]' "${PRJURY_INPUT_DIR}/greptile.raw.json" > "${PRJURY_INPUT_DIR}/greptile.json" || echo "[]" > "${PRJURY_INPUT_DIR}/greptile.json"

      - uses: actions/upload-artifact@v4
        with:
          name: greptile-json
          path: ${{ env.PRJURY_INPUT_DIR }}/greptile.json

  cursor:
    if: ${{ vars.PRJURY_RUN_CURSOR == 'true' }}
    runs-on: ubuntu-latest
    env:
      PRJURY_INPUT_DIR: ${{ env.PRJURY_INPUT_DIR }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Cache cursor CLI
        uses: actions/cache@v4
        with:
          path: ~/.cache/cursor
          key: ${{ runner.os }}-cursor-cli-v1

      - run: mkdir -p "$PRJURY_INPUT_DIR"

      - name: Install cursor CLI
        run: |
          npm install -g cursor-cli || true

      - name: Cursor adapter
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          if command -v cursor >/dev/null 2>&1; then
            cursor review \
              --diff "origin/${{ github.event.pull_request.base.ref }}...HEAD" \
              --format json \
              --output "${PRJURY_INPUT_DIR}/cursor.json" || true
          else
            echo "cursor CLI not installed; skipping." && echo "[]" > "${PRJURY_INPUT_DIR}/cursor.json"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: cursor-json
          path: ${{ env.PRJURY_INPUT_DIR }}/cursor.json

  review:
    needs: [codex, gemini, greptile, cursor]
    runs-on: ubuntu-latest
    env:
      PRJURY_INPUT_DIR: ${{ env.PRJURY_INPUT_DIR }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - run: mkdir -p "$PRJURY_INPUT_DIR"

      - name: Download Codex output
        if: ${{ vars.PRJURY_RUN_CODEX == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: codex-json
          path: ${{ env.PRJURY_INPUT_DIR }}
          if-no-files-found: ignore

      - name: Download Gemini output
        if: ${{ vars.PRJURY_RUN_GEMINI == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: gemini-json
          path: ${{ env.PRJURY_INPUT_DIR }}
          if-no-files-found: ignore

      - name: Download Greptile output
        if: ${{ vars.PRJURY_RUN_GREPTILE == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: greptile-json
          path: ${{ env.PRJURY_INPUT_DIR }}
          if-no-files-found: ignore

      - name: Download Cursor output
        if: ${{ vars.PRJURY_RUN_CURSOR == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: cursor-json
          path: ${{ env.PRJURY_INPUT_DIR }}
          if-no-files-found: ignore

      - name: prjury aggregate and post
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          input-dir: ${{ env.PRJURY_INPUT_DIR }}
          max-comments: "15"
          post-review: "true"
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
